@startuml
title "BatchTrendingCollector Sequence Diagram (Clarity on Exception)"

actor "Caller" as caller
participant "collector: BatchTrendingCollector" as collector
participant "api: YoutubeDataApiCaller" as api
participant "videoCollector: BatchVideoCollector" as videoCollector
participant "creator: TrendingCreator" as creator

caller -> collector : collect(dateTime, collectSize, regionCodes)
activate collector

loop for each regionCode
    note right of collector
        Fetches trending videos page by page
        until 'collectSize' is reached.
        (Approx. collectSize / 50 API calls per region)
    end note
    loop while remainingCount > 0
        collector -> api : fetchTrendings(maxResultCount, regionCode, pageToken)
        activate api
        api --> collector : trendingListResponse
        deactivate api
    end

    collector -> videoCollector : collect(videoYoutubeIds)
    activate videoCollector
    videoCollector --> collector
    deactivate videoCollector

    loop for each trendingVideoResponse
        group try [Create Trending Record]
            collector -> creator : create(dateTime, videoYoutubeId, rank, regionCode)
            activate creator
            creator --> collector
            deactivate creator
        else catch [VideoNotFoundException]
            note over collector : Log exception and continue loop
        end
    end
end

collector --> caller : collectedCount
deactivate collector

@enduml